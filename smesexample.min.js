function createMap(){map=new GMaps({div:"#map",lat:-37.813942,lng:144.9711861,zoom_changed:function(){checkSizeofCurrentMap()},idle:function(){mapMoved()}})}function geoLocate(){GMaps.geolocate({success:function(e){map.setCenter(e.coords.latitude,e.coords.longitude)}}),checkSizeofCurrentMap(),mapMoved()}function mapMoved(){var e=Date.now();lastMapMove=e,window.setTimeout(function(){e===lastMapMove&&redrawMapInfo()},500)}function redrawMapInfo(){var r={};r.lat=map.getCenter().lat(),r.lng=map.getCenter().lng(),r.lat<-180&&(r.lat=r.lat+360),r.lng<-180&&(r.lng=r.lng+360),currentRadius>0&&2>=currentRadius&&retrieveMarkInformation(r.lat,r.lng).then(function(e){e.length>0&&addMarkers(e),mapSpinner.classList.add("hidden")}).catch(function(e){mapSpinner.classList.add("hidden"),console.log(e)})}function returnMarkerIconType(e){var r,n,t,a,o;return r=!1,n=!1,t=!1,a=!1,o=!1,"OK"!=e.status?"mark-defective":("Yes"===e.scn&&(r=!0),""!==e.ahdHeight&&(t=!0),0===String(e.nineFigureNumber).indexOf("1")&&(n=!0),e.gda94Technique.indexOf(scnGDA94Value)>=0&&(a=!0),scnAHDValues.forEach(function(r){e.ahdTechnique.indexOf(r)>=0&&(o=!0)}),r||t?!r&&t?"mark-ahdapprox-pm":r&&n?"mark-scn-gda94-pcm":!r||t||n?r&&t&&!a?"mark-scn-ahd-pm":r&&t&&a&&o?"mark-scn-gda94-ahd-pm":r&&t&&a&&!o?"mark-scn-gda94-ahdapprox-pm":void 0:"mark-scn-gda94-pm":"mark-gda94approx-pm")}function addMarkers(e){var r,n,t,a=!1;t=map.getZoom(),16>t?n=12:t>=16&&17>t?n=14:t>=17&&19>t?n=16:t>=19&&21>t?(n=20,a=!0):(n=24,a=!0),displayingOverlays&&!a&&(map.removeOverlays(),loadedOverlays=[]),e.forEach(function(e){var t=returnMarkerIconType(e);if(r="symbology/"+t+"-"+n+".png",-1===loadedMarks.indexOf(e.nineFigureNumber))map.addMarker({lat:e.latitude,lng:e.longitude,title:e.name,icon:r,infoWindow:{content:'<p class="mdl-color-text--primary"><b>'+e.name+"</b></p><hr><p>Nine Figure Number: "+e.nineFigureNumber+"</p><p>Status: "+e.status+"</p><p>SCN: "+e.scn+"</p><p>Zone: "+e.zone+"</p><p>Easting: "+e.easting+"</p><p>Northing: "+e.northing+"</p><p>AHD Height: "+e.ahdHeight+"</p><p>Ellipsoid Height: "+e.ellipsoidHeight+"</p><p>GDA94 Technique: "+e.gda94Technique+"</p><p>AHD Technique: "+e.ahdTechnique+'</p><hr><button id="sketch'+e.nineFigureNumber+'" class="mdl-button mdl-js-button mdl-button--primary mdl-js-ripple-effect fade-in">&nbsp;&nbsp;Sketch&nbsp;&nbsp;</button>&nbsp;&nbsp;&nbsp;<button id="report'+e.nineFigureNumber+'" class="mdl-button mdl-js-button mdl-button--primary mdl-js-ripple-effect fade-in">&nbsp;&nbsp;Report&nbsp;&nbsp;</button>',domready:function(){document.querySelector("[id=sketch"+e.nineFigureNumber+"]").addEventListener("click",getSurveyMarkSketch,!1),document.querySelector("[id=report"+e.nineFigureNumber+"]").addEventListener("click",getSurveyMarkReport,!1)}},click:function(){currentNineFigureNumber=e.nineFigureNumber,console.log("Opening: "+e.nineFigureNumber)}}),loadedMarks.push(e.nineFigureNumber);else{var o=map.markers.filter(function(r){return r.title===e.name});o[0].icon!==r&&o[0].setIcon(r)}a&&(displayingOverlays=!0,-1===loadedOverlays.indexOf(e.nineFigureNumber)&&(map.drawOverlay({lat:e.latitude,lng:e.longitude,verticalAlign:"bottom",horiztonalAlign:"center",content:'<div class="overlay"><span class="overlay-text">'+e.name+"</span></div>"}),loadedOverlays.push(e.nineFigureNumber)))})}function displayError(){errorMsg.classList.remove("hidden"),errorMsg.textContent="Too many requests have been sent to the server.  Please wait...",window.setTimeout(function(){clearError()},1e3)}function clearError(){errorMsg.classList.add("hidden")}function getSurveyMarkSketch(){clearError(),getSurveyMarkSketchResponse(currentNineFigureNumber).then(function(e){saveAs(dataURItoBlob("data:application/pdf;base64,"+encodeURI(e.document)),"Survey Mark "+currentNineFigureNumber+" Sketch Report.pdf")}).catch(function(e){console.log(e),displayError(e)})}function getSurveyMarkReport(){clearError(),getSurveyMarkReportResponse(currentNineFigureNumber).then(function(e){saveAs(dataURItoBlob("data:application/pdf;base64,"+encodeURI(e.document)),"Survey Mark "+currentNineFigureNumber+" Full Report.pdf")}).catch(function(e){console.log(e),displayError(e)})}function retrieveMarkInformation(e,r){return clearError(),mapSpinner.classList.remove("hidden"),new Promise(function(n){xr.get(baseURL+"/getMarkInformation",{searchType:"Location",latitude:e,longitude:r,radius:currentRadius,format:"Brief"}).then(function(e){"undefined"==typeof e.messages?(zoomInMsg.classList.add("hidden"),n(e.data)):"More than 250 marks were found for this search. Please refine your search criteria."===e.messages.message?(console.log("Too many marks"),mapSpinner.classList.add("hidden"),zoomInMsg.textContent="Zoom in to see marks",zoomInMsg.classList.remove("hidden")):"No survey marks matched the criteria provided."===e.messages.message?(console.log("No marks found"),zoomInMsg.textContent="Zoom in to see marks",mapSpinner.classList.remove("hidden")):(console.log(e.messages.message),displayError(e.messages.message),mapSpinner.classList.add("hidden"))}).catch(function(e){return console.log(e),displayError(),Promise.reject(e)})})}function getSurveyMarkSketchResponse(e){return new Promise(function(r){xr.get(baseURL+"/getSurveyMarkSketches",{markList:e,returnDefective:!0}).then(function(e){"undefined"==typeof e.messages?r(e.data):console.log(e.messages.message)}).catch(function(e){return console.log(e),displayError(),Promise.reject(e)})})}function getSurveyMarkReportResponse(e){return new Promise(function(r){xr.get(baseURL+"/getSurveyMarkReports",{markList:e,returnDefective:!0}).then(function(e){"undefined"==typeof e.messages?r(e.data):console.log(e.messages.message)}).catch(function(e){return console.log(),Promise.reject(e)})})}function checkSizeofCurrentMap(){var e=map.getBounds();if("undefined"!=typeof e){var r=getDistanceKms(map.getCenter().lat(),map.getCenter().lng(),map.getBounds().getSouthWest().lat(),map.getBounds().getSouthWest().lng());currentRadius=r/1e3}else currentRadius=0;currentRadius>0&&2>=currentRadius?zoomInMsg.classList.add("hidden"):(zoomInMsg.textContent="Zoom in to see marks",zoomInMsg.classList.remove("hidden"))}function getDistanceKms(e,r,n,t){var a=6378137,o=calcRad(n-e),s=calcRad(t-r),i=Math.sin(o/2)*Math.sin(o/2)+Math.cos(calcRad(e))*Math.cos(calcRad(n))*Math.sin(s/2)*Math.sin(s/2),c=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),u=a*c;return u}function calcRad(e){return e*Math.PI/180}function dataURItoBlob(e){for(var n=window.atob(e.split(",")[1]),a=(e.split(",")[0].split(":")[1].split(";")[0],new ArrayBuffer(n.length)),o=new Uint8Array(a),s=0;s<n.length;s++)o[s]=n.charCodeAt(s);var i=new Blob([a]);return i}var map,currentNineFigureNumber,currentRadius,loadedMarks=[],loadedOverlays=[],mapSpinner,locateButton,zoomInMsg,errorMsg,displayingOverlays=!1,lastMapMove=Date.now(),baseURL="https://maps.land.vic.gov.au/lvis/services/smesDataDelivery",scnAHDValues=["ZEROTH ORDER","2ND ORDER","3RD ORDER","SPIRIT LEVELLING"],scnGDA94Value="ADJUSTMENT",pcmSearchText="PCM";window.addEventListener("load",function(){mapSpinner=document.querySelector("[id=map-spinner]"),zoomInMsg=document.querySelector("[id=zoom-in-msg]"),errorMsg=document.querySelector("[id=error-msg]"),locateButton=document.querySelector("[id=locate]"),locateButton.addEventListener("click",geoLocate,!1),createMap(),geoLocate()},!1);