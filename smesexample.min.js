function mapMoved(){var n=map.getCenter();n.H<-180&&(n.H=n.H+360),n.L<-180&&(n.L=n.L+360),map.removeMarkers(),map.removeOverlays(),currentRadius>0&&2>=currentRadius&&retrieveMarkInformation(n.H,n.L).then(function(e){e.length>0&&addMarkers(e),mapSpinner.classList.add("hidden")}).catch(function(e){mapSpinner.classList.add("hidden"),console.log(e)})}function returnMarkerIconType(e){var n,r,t,a,i;return n=!1,r=!1,t=!1,a=!1,i=!1,"OK"!=e.status?"mark-defective":("Yes"===e.scn&&(n=!0),""!==e.ahdHeight&&(t=!0),0===String(e.nineFigureNumber).indexOf("1")&&(r=!0),e.gda94Technique.indexOf(scnGDA94Value)>=0&&(a=!0),scnAHDValues.forEach(function(n){e.ahdTechnique.indexOf(n)>=0&&(i=!0)}),n||t?!n&&t?"mark-ahdapprox-pm":n&&r?"mark-scn-gda94-pcm":!n||t||r?n&&t&&!a?"mark-scn-ahd-pm":n&&t&&a&&i?"mark-scn-gda94-ahd-pm":n&&t&&a&&!i?"mark-scn-gda94-ahdapprox-pm":void 0:"mark-scn-gda94-pm":"mark-gda94approx-pm")}function addMarkers(e){var n,r,t,a=!1;t=map.getZoom(),16>t?r=12:t>=16&&17>t?r=14:t>=17&&19>t?r=16:t>=19&&21>t?(r=20,a=!0):(r=24,a=!0),e.forEach(function(e){n="symbology/"+returnMarkerIconType(e)+"-"+r+".png",map.addMarker({lat:e.latitude,lng:e.longitude,title:e.name,icon:n,infoWindow:{content:'<p class="mdl-color-text--primary"><b>'+e.name+"</b></p><hr><p>Nine Figure Number: "+e.nineFigureNumber+"</p><p>Status: "+e.status+"</p><p>SCN: "+e.scn+"</p><p>Zone: "+e.zone+"</p><p>Easting: "+e.easting+"</p><p>Northing: "+e.northing+"</p><p>AHD Height: "+e.ahdHeight+"</p><p>Ellipsoid Height: "+e.ellipsoidHeight+"</p><p>GDA94 Technique: "+e.gda94Technique+"</p><p>AHD Technique: "+e.ahdTechnique+'</p><hr><button id="sketch'+e.nineFigureNumber+'" class="mdl-button mdl-js-button mdl-button--primary mdl-js-ripple-effect fade-in">&nbsp;&nbsp;Sketch&nbsp;&nbsp;</button>&nbsp;&nbsp;&nbsp;<button id="report'+e.nineFigureNumber+'" class="mdl-button mdl-js-button mdl-button--primary mdl-js-ripple-effect fade-in">&nbsp;&nbsp;Report&nbsp;&nbsp;</button>',domready:function(){document.querySelector("[id=sketch"+e.nineFigureNumber+"]").addEventListener("click",getSurveyMarkSketch,!1),document.querySelector("[id=report"+e.nineFigureNumber+"]").addEventListener("click",getSurveyMarkReport,!1)}},click:function(){currentNineFigureNumber=e.nineFigureNumber,console.log("Opening: "+e.nineFigureNumber)}}),a&&map.drawOverlay({lat:e.latitude,lng:e.longitude,verticalAlign:"bottom",horiztonalAlign:"center",content:'<div class="overlay"><span class="overlay-text">'+e.name+"</span></div>"})})}function createMap(){map=new GMaps({div:"#map",lat:-37.813942,lng:144.9711861,dragend:function(){mapMoved()},zoom_changed:function(){checkSizeofCurrentMap(),mapMoved()}})}function geoLocate(){GMaps.geolocate({success:function(e){map.setCenter(e.coords.latitude,e.coords.longitude)}}),checkSizeofCurrentMap(),mapMoved()}function getSurveyMarkSketch(){getSurveyMarkSketchResponse(currentNineFigureNumber).then(function(e){window.open("data:application/pdf;base64,"+encodeURI(e.document),"Survey Sketch Report "+currentNineFigureNumber)}).catch(function(e){console.log(e)})}function getSurveyMarkReport(){getSurveyMarkReportResponse(currentNineFigureNumber).then(function(e){window.open("data:application/pdf;base64,"+encodeURI(e.document),"Survey Mark Report "+currentNineFigureNumber)}).catch(function(e){console.log(e)})}function retrieveMarkInformation(e,n){return mapSpinner.classList.remove("hidden"),new Promise(function(r){xr.get(baseURL+"/getMarkInformation",{searchType:"Location",latitude:e,longitude:n,radius:currentRadius,format:"Brief"}).then(function(e){"undefined"==typeof e.messages?(zoomInMsg.classList.add("hidden"),r(e.data)):"More than 250 marks were found for this search. Please refine your search criteria."===e.messages.message?(console.log("Too many marks"),mapSpinner.classList.add("hidden"),zoomInMsg.textContent="Zoom in to see marks",zoomInMsg.classList.remove("hidden")):"No survey marks matched the criteria provided."===e.messages.message?(console.log("No marks found"),zoomInMsg.textContent="Zoom in to see marks",mapSpinner.classList.remove("hidden")):(console.log(e.messages.message),mapSpinner.classList.add("hidden"))}).catch(function(e){return console.log(e),Promise.reject(e)})})}function getSurveyMarkSketchResponse(e){return new Promise(function(n){xr.get(baseURL+"/getSurveyMarkSketches",{markList:e,returnDefective:!0}).then(function(e){"undefined"==typeof e.messages?n(e.data):console.log(e.messages.message)}).catch(function(e){return console.log(e),Promise.reject(e)})})}function getSurveyMarkReportResponse(e){return new Promise(function(n){xr.get(baseURL+"/getSurveyMarkReports",{markList:e,returnDefective:!0}).then(function(e){"undefined"==typeof e.messages?n(e.data):console.log(e.messages.message)}).catch(function(e){return console.log(e),Promise.reject(e)})})}function checkSizeofCurrentMap(){var e=map.getCenter(),n=map.getBounds();if("undefined"!=typeof n){var r=getDistanceKms(e.H,e.L,n.Ka.H,n.Ga.H);currentRadius=r/1e3}else currentRadius=0;currentRadius>0&&2>=currentRadius?zoomInMsg.classList.add("hidden"):(zoomInMsg.textContent="Zoom in to see marks",zoomInMsg.classList.remove("hidden"))}function getDistanceKms(e,n,r,t){var a=6378137,i=calcRad(r-e),o=calcRad(t-n),s=Math.sin(i/2)*Math.sin(i/2)+Math.cos(calcRad(e))*Math.cos(calcRad(r))*Math.sin(o/2)*Math.sin(o/2),c=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)),u=a*c;return u}function calcRad(e){return e*Math.PI/180}var map,currentNineFigureNumber,currentRadius,mapSpinner,locateButton,zoomInMsg,baseURL="http://maps.test.land.vic.gov.au/lvis/services/smesDataDelivery",scnAHDValues=["ZEROTH ORDER","2ND ORDER","3RD ORDER","SPIRIT LEVELLING"],scnGDA94Value="ADJUSTMENT",pcmSearchText="PCM";window.addEventListener("load",function(){mapSpinner=document.querySelector("[id=map-spinner]"),zoomInMsg=document.querySelector("[id=zoom-in-msg]"),locateButton=document.querySelector("[id=locate]"),locateButton.addEventListener("click",geoLocate,!1),createMap(),geoLocate()},!1);